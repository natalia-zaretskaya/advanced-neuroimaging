## fMRI preprocessing:past and present

Natalia Zaretskaya

::: {.notes}
I am relatively new here, so before introducing fMRI I would like to introduce myself. My name is Natalia, I am a postdoc here at the center. I did my PhD in tuebingen, Germany in Visual/cognitive neuroscience. And now I am working here at the center mostly with Jon Polimeni on high-resolution fMRI. Today we will introduce ourselves to fMRI.
:::

## Content

Standard preprocessing steps
SPM
FS-FAST

::: {.notes}
I thought about it as a very very general introduction. So here is the outline of what I wanted to discuss.
I think we can’t discuss the fMRI without reminding ourselves about what we are mesuring, so I thought we very priefley go over the nature of fMRI signal and the relationship of fMRI and neural activity.
After this, we will use a classical example of a flickering checkerboard stimulus and go through all the ususal stages of preprocessing and Analysis.
I can’t pormise you that by the end of this lecture you will be able to do it right away, but at least you will have a general idea about what are the steps you need to take.
:::

## A typical experiment

TR

20 s on

20 s off

![Slide Image](images/slide_3_img.png)

![Slide Image](images/slide_3_img.png)

![Slide Image](images/slide_3_img.png)

![Slide Image](images/slide_3_img.png)

::: {.notes}
To help us better understand the analysis steps, let’s use an example.
Let’s say we have conducted a calssical experiment in the visual system, a flickerign checkerboard.
In this experiment, we want to find out which brain areas are active when subjects view a flickering checkerboard compared to when they view a gray background.
We have shown to every volunteer a checkerboard for e.g. 20 second interleaved with a 20 s rest, and we will measure a whole brain volume every 2 seconds, for e.g. to minutes or so.


Matlab code to generate stimulus, BOLD and shifted BOLDX = [1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0];
bf = spm_get_bf; % indicated a tr of 2.5
Y = conv(X,bf.bf);
Ye = Y+randn(size(Y)).*0.2;
:::

## A typical research question

Which areas are activated by flickering checkerboard?

::: {.notes}

:::

## 4D functional dataset

time

3D

Repetition time (TR)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

![Slide Image](images/slide_5_img.png)

::: {.notes}
And, in a functional experiment we usually measure brain activity across the whole volume over extended perionds of time, so it is comfortalbe to think about each functional dataset that we acquire as a 4D dataset, which consists of 3D brain volumes and time as a 4th dimension
:::

## Analysis steps

::: {.notes}
An fMRI analysis typcally consists of preprocessing, single-subject analysis and group analysis
Preprocessing is not necessary, but should considerably increase the data quality, so usually everywone does it.
Group analysis allows to make inference about the poplutlation you have sampled from.
:::

## Different software, different philosophies

http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/

http://www.fil.ion.ucl.ac.uk/spm/

https://surfer.nmr.mgh.harvard.edu/fswiki/FsFast

http://afni.nimh.nih.gov/afni/

Doug Greve

https://github.com/wanderine/BROCCOLI/

Since 1994

Since 2000

Since 1994

![Slide Image](images/slide_7_img.png)

![Slide Image](images/slide_7_img.png)

![Slide Image](images/slide_7_img.png)

![Slide Image](images/slide_7_img.png)

![Slide Image](images/slide_7_img.png)

![Slide Image](images/slide_7_img.png)

![Slide Image](images/slide_7_img.png)

::: {.notes}
There are many different software tools for fMRI analysis.
Here I just put a fiew of them.
Each of them has a slightly different phylosophy behind it, but all of them do roughly the same thing, so at the end it should not matter much which of them you use.
SPM – statistical parameteric mapping. It is a free  matlab based toolbox. However, it depends on the matlab licence.
FSL from oxford – a set of linux tools, also free 
These three are sort of older guys and the way they perform computations also got older. Nowdays there are also newer software like this one called broccolli, that can utilize GPU computing and can process the same dataset n times faster.
And last but not least, since we are here at the martinos center, I guess it is convinient to use the centeres freesurfer and fsfast routine. As you may know, freesurfer is a structural popline for cortial surface reconstruction and lot’s of other things. FsFast, developped by doug greeve, is a funcitonal module, which is very well integrated with freesurfer, and has several advantages over these two.
:::

## SPM vs. FS-FAST

Doug Greve

![Slide Image](images/slide_8_img.png)

::: {.notes}
http://buddyboy600.deviantart.com/art/London-Big-Ben-vs-Boston-Custom-House-525853803
Today we will focus on the two software packages, SPM on one hand, and fsFAST on the other. 
One of the main reasons for this choice is because I am most familiar with these two ones, and can’t tell you much about the other ones. 
Another reason is bacuase SPM in particular, as I mentioned, is one of the oldest software packages and one of the most popular ones, and many of the general principles of fMRI analysis were invented and first implemented in SPM. We will compare it with fsfast and see what are the advantages and disadvatages of each.
:::

## SPM vs. FS-FAST

GUI and usage
Philosophies
Preprocessing
First-level and group analysis
Bonus: functional connectivity

::: {.notes}

:::

## Typical fMRI preprocessing stream

Susceptibility distortion estimation

::: {.notes}

:::

## Typical fMRI preprocessing stream

Susceptibility distortion estimation

::: {.notes}

:::

## Motion correction

Purpose: compensate for subject movement

::: {.notes}
One of the first preoprocessign steps is motion correction.
Why do we need motion correction?
During the fMRI experiment the subject is supposed to lay still inside the scanner, and they usually do so.
However, even your best volunteer won’t be perfect. And in fMRI, even a frew millimeters screw up your experiemnt. 
Here is an example. Let’s say we are measuring a voxel located on the left hemishere, and the subject suddently moved.
As a result, the same voxel will be now recording activity from the empty space between the hemispheres, or even form the opposite hemisphere.
:::

## Motion correction

# volume

6 parameter “rigid body” transform

3x

3x

Purpose: compensate for subject movement

![Slide Image](images/slide_13_img.png)

::: {.notes}
Usually, motion is much smaller, but we still want to correct it.
How do we do this? Luckily there are special angorythms that can estimate the amoutnt of motion from one volume to the next.
This is usally done using 6 degrees of freedom: trhasnlation in x, y, and z and rotation in x, y, and z. This is called the rigid body transform, because you do not change the size and shape of the volume, but simply rotate it in space.
After the amount of motion has been calculated, it can be applied to every image to align it back to the necessary position.
:::

## Slice-time correction

Purpose: compensate for the lag in slice acquisition

ascending

interleaved

![Slide Image](images/slide_14_img.png)

![Slide Image](images/slide_14_img.png)

![Slide Image](images/slide_14_img.png)

::: {.notes}
The next preprocessing step is slice-time correction.
What is slice time correction and why do we need it?
Remember that typically a functional volume is acquired not all at once, but slice-by-slice, as illustrated here. There are different ways in which the scanner can acquire the slices: it can bie botton-to top (ascending), decending, interleaved. There are also more complex slice acquisition patterns. Remember that the time it takes to acquire one volume is relatively long, in this our example it is 2 seconds. 
Let’s say a stimulus activates two areas, here and here in the same manner.
If we acquire the slices in an asciending manner, we will measure a small signal amplitude in the frist area. By the time we arrive to the second area, the signal amplitude will increase in both areas, so we will measure a highre signal amplitude in the second area.
:::

## Slice-time correction

Purpose: compensate for the lag in slice acquisition

0 s

2.5 s

::: {.notes}
Here is another way of illustrating the same issue.
The purpose of the slice-time correction realignes signals from all slices in time as if they were acquired at the same time.
:::

## Slice time correction: before or after motion correction?

0 s

2.5 s

0 s

2.5 s

::: {.notes}

:::

## SPM vs. FS-FAST

SPM

FS-FAST

Slice-time correction
Motion correction

Motion correction
Slice-time correction

::: {.notes}

:::

## Slice-time correction

Mostly relevant for event-related designs or timing comparisons
Can be substituted by modeling HRF derivatives if you are not interested in timing/time course analysis

::: {.notes}

:::

## Slice-time correction for simultaneous multislice acquisition (SMS)

sequential

SMS

16
15
14
13
12
11
10
9
8
7
6
5
4
3
2
1

0 s

2.5 s

8
7
6
5
4
3
2
1
8
7
6
5
4
3
2
1

0 s

1. 25 s

![Slide Image](images/slide_19_img.png)

![Slide Image](images/slide_19_img.png)

::: {.notes}

:::

## SPM vs. FS-FAST

SPM12

You can now add slice time (instead of slice order) as input for SMS acquisition

FS-FAST

Not in the stable 5.3 version
(perhaps in FreeSurfer 6?)
You can also use an FSL command distributed with FreeSurfer

::: {.notes}

:::

## Example

Work by Marilena Wilding
https://doi.org/10.1101/2022.01.13.476145

![Slide Image](images/slide_21_img.png)

![Slide Image](images/slide_21_img.png)

::: {.notes}

:::

## Typical fMRI preprocessing stream

Susceptibility distortion estimation

::: {.notes}

:::

## Susceptibility distortions

https://mriquestions.com/susceptibility-artifact.html

![Slide Image](images/slide_23_img.png)

![Slide Image](images/slide_23_img.png)

::: {.notes}

:::

## Estimate the deformation field

https://mriquestions.com/susceptibility-artifact.html

Fieldmap

TOPUP

https://andysbrainbook.readthedocs.io/en/latest/TBSS/TBSS_Course/TBSS_04_TopUpEddy.html

![Slide Image](images/slide_24_img.png)

::: {.notes}

:::

## Apply the deformation field

::: {.notes}

:::

## Typical fMRI preprocessing stream

Susceptibility distortion estimation

::: {.notes}

:::

## Co-registration

Purpose1: view activations on a high quality anatomical image (and more)

![Slide Image](images/slide_27_img.png)

::: {.notes}

:::

## SPM: Mutual information maximization

Bianca de Haan’s fMRI guide
http://mbesc.net/wp-content/uploads/2014/07/fmri_guide.pdf

::: {.notes}
Read 
http://www.ncbi.nlm.nih.gov/pubmed/19573611
:::

## FS-FAST: boundary-based registration

Greve and Fischl, NeuroImage, 2005

Currently considered best for its purpose !

![Slide Image](images/slide_29_img.png)

::: {.notes}
Read 
http://www.ncbi.nlm.nih.gov/pubmed/19573611
:::

## Typical fMRI preprocessing stream

::: {.notes}

:::

## “Normalization” to common space

http://publicdomainreview.org/collections/phrenology-diagrams-from-vaughts-practical-character-reader-1902/

Purpose1: compensate individual differences in brain shape for the group analysis

::: {.notes}
Finally, if you are preforming a group study, you also need to map each individual subject into some common space.
This is not a trivial task.
As head shpaes of people are different, there brain shapes are also different.
Here I tried to draw the approximate shape if each of these guy’s brains, and some hypotheitcal template brain.
:::

## Templates & coordinate systems

Talairach

http://imaging.mrc-cbu.cam.ac.uk/imaging/MniTalairach

MNI

Purpose2: Unified coordinate system

::: {.notes}

:::

## Template

Rigid transform

6 parameter rigid transform

3x

3x

![Slide Image](images/slide_33_img.png)

![Slide Image](images/slide_33_img.png)

::: {.notes}
To match each of them to the template, it is not enough to coregister them as we did for motion correction, because obviously they are of different sizes
:::

## Affine transform

12 parameter affine transform

3x

3x

3x

3x

![Slide Image](images/slide_34_img.png)

![Slide Image](images/slide_34_img.png)

::: {.notes}
We can add 6 more paraeters to the transform, which compensates does scaling and shearing, to better align them.
However, there will still be places wehere they do not align perfectly, because one guy one has a bigger frontal lobe, and gy to a bigger parietal lobe
:::

## Nonlinear transform

“warping”

Source

Deformation field

Warped image

Template

![Slide Image](images/slide_35_img.png)

![Slide Image](images/slide_35_img.png)

::: {.notes}
So some software packages use a nonlinear warping algorythm to align brains. There you have to estimate a 3D deformation field and then nonlinearly warp each brain onto a template. They are called non-linear, because different parts of the volume are scaled differently.
:::

## Normalization is usually done using a structural scan

::: {.notes}
The mapping to common space is usally done via an anatomical scan. First, each subject functional and anatomical scans are coregistered with each other, and then each subject’s anatomical scan is mapped into a template. This is done because the anatomical scan has better quality, and hence the estimated transform is more preceise.
After you have done that each area in one subject corresponds to the same area in the other subject and you can perform averaging on them.
:::

## SPM: unified segmentation

Bias correction
Tissue segmentation
Normalization parameters

s14_seg8.mat

J. Ashburner and K.J. Friston, NeuroImage , 2005.

![Slide Image](images/slide_37_img.png)

::: {.notes}

:::

## FS-FAST: surface-based registration

individual

fsaverage template

![Slide Image](images/slide_38_img.png)

![Slide Image](images/slide_38_img.png)

![Slide Image](images/slide_38_img.png)

![Slide Image](images/slide_38_img.png)

![Slide Image](images/slide_38_img.png)

![Slide Image](images/slide_38_img.png)

::: {.notes}
Fsaverage: 40 subjects;
Align 39 subjects to 1; create an atlas; align 40 subjects to an atlas; re-create atlas; align 40 subject to the atlas; re-create atlas
:::

## Slide adapted from Doug Greve

FS-FAST

![Slide Image](images/slide_39_img.png)

::: {.notes}
The preprocessing stream then looks as follows:
We got functional dataset out of the scanner. It is a stack of volumes (in 3D), each consisting of single voxels. Each voxel has a time course. So essentially it is a 4D dataset, wehere we treat time as the fourth diemsion. 
We first perfomr motion correciton and slice time correction in the volume space, as is done by most other software packages.  
But after that, using knolwdge from freesurfer recon, each voxel together with it’s time course is maped to one of the 3 atlas spaces: either the left cortical hemisphere, the right hemisphere or the subcrotical structures like the basal ganglia, amygldala, brainstem, etc. And the atlas spaces in this case are fsaverage.
After this, the spatial smoothing is done either in 2D or in 3D depending on whether it is a surface space or a volume subcortical space, and voxels that do not belong to the space is being basked out.
:::

## Typical fMRI preprocessing stream

::: {.notes}

:::

## Spatial smoothing

0 FWHM

5 FWHM

10 FWHM

Full-Width/Half-max

Purpose1: increase the signal and suppress the noise
Purpose2: even better compensate for inter-individual differences

![Slide Image](images/slide_41_img.png)

![Slide Image](images/slide_41_img.png)

![Slide Image](images/slide_41_img.png)

::: {.notes}
Finally, each volume is typically smoothed with a gaussian to increase the signal and supress noise. 
The amount of smoothing is usally expressed by the shape of the gaussian, which, in turn, is described by it’s full withd at half maximum. Here are the examples of the original volume, the smoothed volume at 5 fwhm and 10 fwhm. You can see that the signal increase happends at the expense of the spatialresolution
:::

## Untitled Slide

![Slide Image](images/slide_42_img.png)

![Slide Image](images/slide_42_img.png)

::: {.notes}
Volume smoothing has been heavily critisized by some influential people in the field. It has even been called “deficient approaches to human neuroimaging”. 
Because it does not only degrade the resoulution, but also decreases the effect size. 
But it is still being done in many cases – it all depends on the questions you are asking
:::

## Spatial smoothing

0 FWHM

5 FWHM

10 FWHM

Full-Width/Half-max

Purpose1: increase the signal and suppress the noise
Purpose2: even better compensate for inter-individual differences

![Slide Image](images/slide_43_img.png)

![Slide Image](images/slide_43_img.png)

![Slide Image](images/slide_43_img.png)

::: {.notes}
Finally, each volume is typically smoothed with a gaussian to increase the signal and supress noise. 
The amount of smoothing is usally expressed by the shape of the gaussian, which, in turn, is described by it’s full withd at half maximum. Here are the examples of the original volume, the smoothed volume at 5 fwhm and 10 fwhm. You can see that the signal increase happends at the expense of the spatialresolution
:::

## slide courtesy of Doug Greve

Volume- vs. Surface-based smoothing

5 mm apart in 3D
25 mm apart on surface
Averaging with other tissue types (WM, CSF)
Averaging with other functional areas

14 mm FWHM

![Slide Image](images/slide_44_img.png)

::: {.notes}
One important feature is that fsfast allows surface-based processing, and therefore overcomes some of the dificulties caused by smoothing.

Here is an example of how it works. Here is a piece of freesrurfer reocnstructed cortical surface with yellow a white matter surface and red the the gray matter surface. The two points, on opposite banks of the sulcus, are only 5 mm apart in the volume, 
howerver, they are very far from each other on the surface. So these two points can be two completely different functiona areas. 
However, if you smooth on the volume, as shown here, you will mix them thogether. 
FsFast uses the information from the freesurfer’s surface reconstruciton and smoothes the data along the cortical surface. This allows to take advanta of smoothing procedure without mixing these two areas together.
:::

## FS-FAST

::: {.notes}

:::

## In the 21st century…

https://fmriprep.org/en/stable/

::: {.notes}

:::

## https://fmriprep.org/en/stable/

![Slide Image](images/slide_47_img.png)

::: {.notes}

:::

## fMRIprep

Pros

Useful for many subjects, whole-brain data, standard acquisitions
Collection of best practices from all software
HPC compatibility
Useful for “users” when knowledgeable people do it for them
Automatic quality control
Increases reproducibility (?)

Cons

Not useful for custom acquisitions
May not worth it with few subjects
Requires a Linux environment and corresponding knowledge
Need integration with the software you will use for your analysis
Hard to explain what you did in a paper

![Slide Image](images/slide_48_img.png)

::: {.notes}

:::

## Example I

Work by Ana Arsenovic

![Slide Image](images/slide_49_img.png)

![Slide Image](images/slide_49_img.png)

::: {.notes}

:::

## Example II

Work by Adam Coates

7T - 0.75mm

![Slide Image](images/slide_50_img.png)

![Slide Image](images/slide_50_img.png)

![Slide Image](images/slide_50_img.png)

![Slide Image](images/slide_50_img.png)

![Slide Image](images/slide_50_img.png)

::: {.notes}

:::

## Break or the End

::: {.notes}

:::

## Useful links

SPM
http://www.fil.ion.ucl.ac.uk/spm/doc/
http://imaging.mrc-cbu.cam.ac.uk/imaging/SpmMiniCourse
FS-FAST
https://surfer.nmr.mgh.harvard.edu/fswiki/FsFastTutorialV5.1
https://surfer.nmr.mgh.harvard.edu/pub/docs/fsfast.april2011.ppt (Doug’s FS-FAST lecture slides)
https://www.youtube.com/watch?v=Q1RoThGmuxk

::: {.notes}

:::

