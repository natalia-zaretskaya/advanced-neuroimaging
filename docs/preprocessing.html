<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Preprocessing – Advanced Neuroimaging</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./data_management.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-8da5b4427184b79ecddefad3d342027e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./preprocessing.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Preprocessing</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logo/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Advanced Neuroimaging</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Syllabus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fmri-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to fMRI</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./paradigm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Experimental paradigm</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preprocessing.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Preprocessing</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#reminder-a-typical-experiment" id="toc-reminder-a-typical-experiment" class="nav-link active" data-scroll-target="#reminder-a-typical-experiment">Reminder: a typical experiment</a></li>
  <li><a href="#d-functional-dataset" id="toc-d-functional-dataset" class="nav-link" data-scroll-target="#d-functional-dataset">4D functional dataset</a></li>
  <li><a href="#major-software" id="toc-major-software" class="nav-link" data-scroll-target="#major-software">Major software</a></li>
  <li><a href="#fmriprep" id="toc-fmriprep" class="nav-link" data-scroll-target="#fmriprep">fMRIprep</a></li>
  <li><a href="#anatomical-preprocessing" id="toc-anatomical-preprocessing" class="nav-link" data-scroll-target="#anatomical-preprocessing">Anatomical preprocessing</a>
  <ul class="collapse">
  <li><a href="#bias-field-correction" id="toc-bias-field-correction" class="nav-link" data-scroll-target="#bias-field-correction">Bias field correction</a></li>
  <li><a href="#surface-reconstruction" id="toc-surface-reconstruction" class="nav-link" data-scroll-target="#surface-reconstruction">Surface reconstruction</a></li>
  <li><a href="#normalization" id="toc-normalization" class="nav-link" data-scroll-target="#normalization">Normalization</a></li>
  </ul></li>
  <li><a href="#functional-preprocessing" id="toc-functional-preprocessing" class="nav-link" data-scroll-target="#functional-preprocessing">Functional preprocessing</a>
  <ul class="collapse">
  <li><a href="#non-steady-state-artifacts" id="toc-non-steady-state-artifacts" class="nav-link" data-scroll-target="#non-steady-state-artifacts">Non-steady-state artifacts</a>
  <ul class="collapse">
  <li><a href="#aka-t1-equilibration-artifacts" id="toc-aka-t1-equilibration-artifacts" class="nav-link" data-scroll-target="#aka-t1-equilibration-artifacts">Aka T1 equilibration artifacts</a></li>
  </ul></li>
  <li><a href="#motion-correction" id="toc-motion-correction" class="nav-link" data-scroll-target="#motion-correction">Motion correction</a>
  <ul class="collapse">
  <li><a href="#purpose-compensate-for-subject-movement" id="toc-purpose-compensate-for-subject-movement" class="nav-link" data-scroll-target="#purpose-compensate-for-subject-movement">Purpose: compensate for subject movement</a></li>
  </ul></li>
  <li><a href="#motion-correction-1" id="toc-motion-correction-1" class="nav-link" data-scroll-target="#motion-correction-1">Motion correction</a></li>
  <li><a href="#plot-motion-parameters" id="toc-plot-motion-parameters" class="nav-link" data-scroll-target="#plot-motion-parameters">Plot motion parameters</a></li>
  <li><a href="#slice-time-correction" id="toc-slice-time-correction" class="nav-link" data-scroll-target="#slice-time-correction">Slice-time correction</a>
  <ul class="collapse">
  <li><a href="#purpose-compensate-for-the-lag-in-slice-acquisition" id="toc-purpose-compensate-for-the-lag-in-slice-acquisition" class="nav-link" data-scroll-target="#purpose-compensate-for-the-lag-in-slice-acquisition">Purpose: compensate for the lag in slice acquisition</a></li>
  </ul></li>
  <li><a href="#slice-time-correction-1" id="toc-slice-time-correction-1" class="nav-link" data-scroll-target="#slice-time-correction-1">Slice-time correction</a></li>
  <li><a href="#slice-time-correction-before-or-after-motion-correction" id="toc-slice-time-correction-before-or-after-motion-correction" class="nav-link" data-scroll-target="#slice-time-correction-before-or-after-motion-correction">Slice time correction: before or after motion correction?</a></li>
  <li><a href="#simultaneous-multislice-smsmultiband-mb-acquisitions" id="toc-simultaneous-multislice-smsmultiband-mb-acquisitions" class="nav-link" data-scroll-target="#simultaneous-multislice-smsmultiband-mb-acquisitions">Simultaneous multislice (SMS)/multiband (MB) acquisitions</a></li>
  <li><a href="#susceptibility-distortions" id="toc-susceptibility-distortions" class="nav-link" data-scroll-target="#susceptibility-distortions">Susceptibility distortions</a></li>
  <li><a href="#field-map" id="toc-field-map" class="nav-link" data-scroll-target="#field-map">Field map</a></li>
  <li><a href="#reverse-pe-polarity" id="toc-reverse-pe-polarity" class="nav-link" data-scroll-target="#reverse-pe-polarity">Reverse PE polarity</a></li>
  <li><a href="#apply-the-deformation-field" id="toc-apply-the-deformation-field" class="nav-link" data-scroll-target="#apply-the-deformation-field">Apply the deformation field</a></li>
  <li><a href="#co-registration" id="toc-co-registration" class="nav-link" data-scroll-target="#co-registration">Co-registration</a></li>
  <li><a href="#mutual-information-maximization" id="toc-mutual-information-maximization" class="nav-link" data-scroll-target="#mutual-information-maximization">Mutual information maximization</a></li>
  <li><a href="#boundary-based-registration" id="toc-boundary-based-registration" class="nav-link" data-scroll-target="#boundary-based-registration">Boundary-based registration</a></li>
  <li><a href="#coregistration-result" id="toc-coregistration-result" class="nav-link" data-scroll-target="#coregistration-result">Coregistration result</a></li>
  <li><a href="#corgistration-before-vs.-after" id="toc-corgistration-before-vs.-after" class="nav-link" data-scroll-target="#corgistration-before-vs.-after">Corgistration before vs.&nbsp;after</a></li>
  <li><a href="#sec-normalization" id="toc-sec-normalization" class="nav-link" data-scroll-target="#sec-normalization">Normalization to template space</a></li>
  <li><a href="#talairach-atlas" id="toc-talairach-atlas" class="nav-link" data-scroll-target="#talairach-atlas">Talairach atlas</a></li>
  <li><a href="#mni-tamplate" id="toc-mni-tamplate" class="nav-link" data-scroll-target="#mni-tamplate">MNI tamplate</a></li>
  <li><a href="#mapping-to-template" id="toc-mapping-to-template" class="nav-link" data-scroll-target="#mapping-to-template">Mapping to template</a></li>
  <li><a href="#nonlinear-transform" id="toc-nonlinear-transform" class="nav-link" data-scroll-target="#nonlinear-transform">Nonlinear transform</a></li>
  <li><a href="#normalization-is-done-using-a-structural-scan" id="toc-normalization-is-done-using-a-structural-scan" class="nav-link" data-scroll-target="#normalization-is-done-using-a-structural-scan">Normalization is done using a structural scan</a></li>
  <li><a href="#volume-based-normalization" id="toc-volume-based-normalization" class="nav-link" data-scroll-target="#volume-based-normalization">Volume-based normalization</a>
  <ul class="collapse">
  <li><a href="#unified-segmentation" id="toc-unified-segmentation" class="nav-link" data-scroll-target="#unified-segmentation">Unified segmentation</a></li>
  </ul></li>
  <li><a href="#surface-based-registration" id="toc-surface-based-registration" class="nav-link" data-scroll-target="#surface-based-registration">Surface-based registration</a></li>
  <li><a href="#spatial-smoothing" id="toc-spatial-smoothing" class="nav-link" data-scroll-target="#spatial-smoothing">Spatial smoothing</a></li>
  <li><a href="#full-width-at-half-maximum" id="toc-full-width-at-half-maximum" class="nav-link" data-scroll-target="#full-width-at-half-maximum">Full width at half maximum</a></li>
  <li><a href="#spatial-smoothing-1" id="toc-spatial-smoothing-1" class="nav-link" data-scroll-target="#spatial-smoothing-1">Spatial smoothing</a></li>
  <li><a href="#critique" id="toc-critique" class="nav-link" data-scroll-target="#critique">Critique</a></li>
  <li><a href="#surface-based-smoothing" id="toc-surface-based-smoothing" class="nav-link" data-scroll-target="#surface-based-smoothing">Surface-based smoothing</a></li>
  <li><a href="#fmriprep-1" id="toc-fmriprep-1" class="nav-link" data-scroll-target="#fmriprep-1">fMRIprep</a></li>
  <li><a href="#example-i" id="toc-example-i" class="nav-link" data-scroll-target="#example-i">Example I</a></li>
  <li><a href="#example-ii" id="toc-example-ii" class="nav-link" data-scroll-target="#example-ii">Example II</a></li>
  <li><a href="#run-fmriprep" id="toc-run-fmriprep" class="nav-link" data-scroll-target="#run-fmriprep">Run fMRIprep</a>
  <ul class="collapse">
  <li><a href="#run-fmriprep-as-follows" id="toc-run-fmriprep-as-follows" class="nav-link" data-scroll-target="#run-fmriprep-as-follows">Run fMRIprep as follows</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Preprocessing</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>of an fMRI dataset</p>
<div class="notes">
<p>Preprocessing of fMRI data is intended for reducing the impact of MR artifacts and enhancing the data quality.</p>
<p>In principle, if the data quality is good and the subject did not move (which is the case for our experiment) preprocessing should not even be necessary. Nevertheless, this is a tradition that goes back to the 1990-es, and researchers mostly stick to it.</p>
<p>The maths behind these steps is oftentimes complicated, and most fMRI ‘users’ do not understand it. Our fMRI lab even offers to provide you with preprocessed data. I think it is important to know what you are doing, so we will go through basic preprocessing steps today.</p>
</div>
<section id="reminder-a-typical-experiment" class="level2">
<h2 class="anchored" data-anchor-id="reminder-a-typical-experiment">Reminder: a typical experiment</h2>
<p><img src="images/clipboard-2847001828.png" class="img-fluid"></p>
<div class="notes">
<p>To help us better understand the preprocessing steps, let’s remind ourselves about a typical fMRI experiment with a flickering checkerboard. In this experiment, we want to find out which brain areas are active when subjects view a flickering checkerboard compared to when they view a gray background. We have shown to every volunteer a checkerboard for e.g.&nbsp;20 second interleaved with a 20 s rest, and we will measure a whole brain volume every 2 seconds, for e.g.&nbsp;to minutes or so.</p>
<p>Matlab code to generate stimulus, BOLD and shifted BOLDX = [1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0]; bf = spm_get_bf; % indicated a tr of 2.5 Y = conv(X,bf.bf); Ye = Y+randn(size(Y)).*0.2;</p>
</div>
</section>
<section id="d-functional-dataset" class="level2">
<h2 class="anchored" data-anchor-id="d-functional-dataset">4D functional dataset</h2>
<p><img src="images/clipboard-531340901.png" class="img-fluid"></p>
<div class="notes">
<p>And, in a functional experiment we usually measure brain activity across the whole volume over extended perionds of time, so it is comfortable to think about each functional dataset that we acquire as a 4D dataset, which consists of 3D brain volumes and time as a 4th dimension.</p>
</div>
</section>
<section id="major-software" class="level2">
<h2 class="anchored" data-anchor-id="major-software">Major software</h2>
<div>

</div>
<div class="quarto-layout-panel" data-layout-nrow="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1248183062.png" class="img-fluid figure-img"></p>
<figcaption>Since 1994 http://www.fil.ion.ucl.ac.uk/spm/</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1300652131.png" class="img-fluid figure-img"></p>
<figcaption>Since 1994 http://afni.nimh.nih.gov/afni/</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-2202486336.png" class="img-fluid figure-img"></p>
<figcaption>Since 2000 http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://freesurfer.net/"><img src="images/fslogosmall.png" class="img-fluid figure-img" alt="https://freesurfer.net/"></a></p>
<figcaption>https://freesurfer.net/</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="notes">
<p>Preprocessing used to be integrated into the software used for the actual analysis. And there are many software for this. On this slide I just put a few of them. Each of them has a slightly different phylosophy behind it, but all of them do roughly the same thing, so at the end it should not matter much which of them you use.</p>
<p>One of the oldest ones are:</p>
<ul>
<li><p>SPM – statistical parameteric mapping from UCL. It is a free MATLAB-based toolbox. However, it depends on the MATLAB licence, and has not been updated for a long time. The new update just came out which spans the gab from 2012 to 2025 <span class="citation" data-cites="tierney2025">(<a href="#ref-tierney2025" role="doc-biblioref">Tierney et al. 2025</a>)</span>.</p></li>
<li><p>AFNI - from NIH</p></li>
<li><p>FSL from Oxford – a set of linux tools, also free and independent of MATLAB, which is an advantage, but requires Linux.</p></li>
<li><p>FreeSurfer/FSFAST form the Martinos center - it is Linux based, and was originally conceived as a tool for structural data analysis, but has an fMRI module</p></li>
</ul>
<p>Historical software</p>
<ul>
<li>broccolli, that can utilize GPU computing and can process the same dataset n times faster</li>
</ul>
<p>With the awareness of open science, and with the trend towards reproducibility and transparency, and with the release of fMRIprep software, the preprocessing got detached from the actual data analysis.</p>
</div>
</section>
<section id="fmriprep" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="fmriprep">fMRIprep</h2>
<p><img src="images/clipboard-3600520399.png" class="img-fluid" width="529"></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>Image source <span class="citation" data-cites="esteban2018">(<a href="#ref-esteban2018" role="doc-biblioref">Esteban et al. 2018</a>)</span></p>
</div></div><div class="notes">
<p>fMRIprep has evolved to combine best practices in fmri preprocessing and also to unify and standardize analysis steps. It is currently dominating the field and is the state-of-the-art way to do preprocessing.</p>
<p>All the steps we will talk about are implemented in fMRIprep.</p>
</div>
</section>
<section id="anatomical-preprocessing" class="level1">
<h1>Anatomical preprocessing</h1>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/anat_pre.png" class="img-fluid figure-img"></p>
<figcaption>before</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/anat_post.png" class="img-fluid figure-img"></p>
<figcaption>after</figcaption>
</figure>
</div>
</div>
</div>
</div>
<section id="bias-field-correction" class="level2">
<h2 class="anchored" data-anchor-id="bias-field-correction">Bias field correction</h2>
<p><img src="images/clipboard-25296982.png" class="img-fluid"></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gambling: view the before and after images by typing</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ml</span> freesurfer</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">freeview</span> <span class="dt">\</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/sub-001/ses-1/anat/sub-001_ses-1_acq-mprage_T1w.nii.gz <span class="dt">\</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/derivatives/fmriprep/sub-001/ses-1/anat/sub-001_ses-1_acq-mprage_desc-preproc_T1w.nii.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="notes">
<p>Varying intensities across the image will confuse subsequent steps.</p>
</div>
</section>
<section id="surface-reconstruction" class="level2">
<h2 class="anchored" data-anchor-id="surface-reconstruction">Surface reconstruction</h2>
<p><img src="images/clipboard-1083312615.png" class="img-fluid"></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gambling: view the reconstructed surfaces by typing</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ml</span> freesurfer</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">freeview</span> <span class="dt">\</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/derivatives/fmriprep/sourcedata/freesurfer/sub-001/mri/orig.mgz <span class="dt">\</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>-f /home/jovyan/gambling/bids/derivatives/fmriprep/sourcedata/freesurfer/sub-001/surf/<span class="pp">*</span>h.white <span class="dt">\</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/derivatives/fmriprep/sourcedata/freesurfer/sub-001/surf/<span class="pp">*</span>h.pial</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="notes">
<p>Relatively lengthy (some hours) multistage fully automatic process</p>
</div>
</section>
<section id="normalization" class="level2">
<h2 class="anchored" data-anchor-id="normalization">Normalization</h2>
<p>Will be discussed in the <a href="#sec-normalization">section on functional data</a></p>
</section>
</section>
<section id="functional-preprocessing" class="level1 page-columns page-full">
<h1>Functional preprocessing</h1>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/func_pre.png" class="img-fluid figure-img"></p>
<figcaption>before</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/func_post.png" class="img-fluid figure-img"></p>
<figcaption>after</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gambling: compare before and after my typing</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ml</span> freesurfer</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">freeview</span> <span class="dt">\</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/sub-001/ses-1/func/sub-001_ses-1_task-gambling_acq-Fs2_run-1_bold.nii.gz <span class="dt">\</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/derivatives/fmriprep/sub-001/ses-1/func/sub-001_ses-1_task-gambling_acq-Fs2_run-1_space-T1w_desc-preproc_bold.nii.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="notes">
<p>As I already mentioned, preprocessing is not strictly necessary, especially with modern 3 Tesla scanners and compliant subjects. It is more important for high-field scanners which contain stronger artifacts, subjects that move a lot, or in spatial scenarios where we want to detect small effects and do not want to make sure we get rid of noise as much as we can.</p>
<p>The curious among you can try performing statistics with and without preprocessing and compare as a bonus task.</p>
<p>Here are the examples of functional and anatomical data before and after preprocessing. Do we see any difference? Not always. Especially for the functional data, the differences are seen over time and not so much over space.</p>
</div>
<section id="non-steady-state-artifacts" class="level2">
<h2 class="anchored" data-anchor-id="non-steady-state-artifacts">Non-steady-state artifacts</h2>
<section id="aka-t1-equilibration-artifacts" class="level3">
<h3 class="anchored" data-anchor-id="aka-t1-equilibration-artifacts">Aka T1 equilibration artifacts</h3>
<p><img src="images/clipboard-2403738611.png" class="img-fluid"></p>
<pre><code># gambling
file:///home/jovyan/gambling/bids/derivatives/mriqc/sub-001/figures/sub-001_ses-1_task-gambling_acq-Fs2_run-1_desc-carpet_bold.svg</code></pre>
<div class="notes">
<p>I could not really spot this artifact in the scans we acquired to show you. This may be due to two facts:</p>
<ul>
<li><p>Our scanner is quite good and modern, so these artifacts are minimal</p></li>
<li><p>The scanning protocol automatically acquires two volumes with those artifacts that are discarded</p></li>
</ul>
<p>Perhaps these large intensity fluctuations on the left (in the beginning) in this carpet plot reflect this.</p>
<p>But non-steady-state artifacts are actually the reason why I asked to include a 10-second period where nothing is happening into the experimental paradigm. Non-steady-state volumes should not overlap with the actual experimental paradigm. In the past, we waited for 4-5 volumes before the actual paradigm started, and then discarded these volumes during preprocessing, so that data and paradigm are temporally aligned. But the non-steady-state volumes have an advantage of having good gray-white matter contrast. Therefore, fMRIprep tries to automatically identify them for each run and use them to produce a “reference scan”, which is used in the subsequent steps.</p>
</div>
</section>
</section>
<section id="motion-correction" class="level2">
<h2 class="anchored" data-anchor-id="motion-correction">Motion correction</h2>
<section id="purpose-compensate-for-subject-movement" class="level3">
<h3 class="anchored" data-anchor-id="purpose-compensate-for-subject-movement">Purpose: compensate for subject movement</h3>
<p><img src="images/clipboard-4060992596.png" class="img-fluid"></p>
<div class="notes">
<p>One of the first preprocessign steps is motion correction. Why do we need motion correction? During the fMRI experiment the subject is supposed to lay still inside the scanner, and they usually do so. However, even your best volunteer won’t be perfect. And in fMRI, even a few millimeters screw up your experiment. Here is an example. Let’s say we are measuring a voxel located on the left hemisphere, and the subject suddenly moved. As a result, the same voxel will be now recording activity from the empty space between the hemispheres, or even form the opposite hemisphere.</p>
</div>
</section>
</section>
<section id="motion-correction-1" class="level2">
<h2 class="anchored" data-anchor-id="motion-correction-1">Motion correction</h2>
<p>6 parameter “rigid body” transform</p>
<p><img src="images/clipboard-298326943.png" class="img-fluid"></p>
<div class="notes">
<p>Usually, motion is much smaller, but we still want to correct it. How do we do this? Luckily there are special algorithms that can estimate the amount of motion from one volume to the next. This is usually done using 6 degrees of freedom: translation in x, y, and z and rotation in x, y, and z. This is called the “rigid body transform”, because you do not change the size and shape of the volume, but simply rotate it in space. After the amount of motion has been calculated, it can be applied to every image to align it back to the necessary position.</p>
</div>
</section>
<section id="plot-motion-parameters" class="level2">
<h2 class="anchored" data-anchor-id="plot-motion-parameters">Plot motion parameters</h2>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="preprocessing_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="slice-time-correction" class="level2">
<h2 class="anchored" data-anchor-id="slice-time-correction">Slice-time correction</h2>
<section id="purpose-compensate-for-the-lag-in-slice-acquisition" class="level3">
<h3 class="anchored" data-anchor-id="purpose-compensate-for-the-lag-in-slice-acquisition">Purpose: compensate for the lag in slice acquisition</h3>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><img src="images/clipboard-11343229.png" class="img-fluid"> <img src="images/clipboard-1984723780.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><img src="images/clipboard-2838093174.png" class="img-fluid"> <img src="images/slide_14_img.png" class="img-fluid"></p>
</div>
</div>
</div>
<div class="notes">
<p>The next preprocessing step is slice-time correction. What is slice time correction and why do we need it? Remember that typically a functional volume is acquired not all at once, but slice-by-slice, as illustrated here. There are different ways in which the scanner can acquire the slices: it can bie botton-to top (ascending), decending, interleaved. There are also more complex slice acquisition patterns. Remember that the time it takes to acquire one volume is relatively long, in this our example it is 2 seconds. Let’s say a stimulus activates two areas, here and here in the same manner. If we acquire the slices in an asciending manner, we will measure a small signal amplitude in the frist area. By the time we arrive to the second area, the signal amplitude will increase in both areas, so we will measure a highre signal amplitude in the second area.</p>
</div>
</section>
</section>
<section id="slice-time-correction-1" class="level2">
<h2 class="anchored" data-anchor-id="slice-time-correction-1">Slice-time correction</h2>
<p><img src="images/clipboard-3049912214.png" class="img-fluid"></p>
<div class="notes">
<p>Here is another way of illustrating the same issue. The purpose of the slice-time correction realigns signals from all slices in time as if they were acquired at the same time.</p>
<p>Mostly relevant for event-related designs or timing comparisons Can be substituted by modeling HRF derivatives if you are not interested in timing/time course analysis.</p>
</div>
</section>
<section id="slice-time-correction-before-or-after-motion-correction" class="level2">
<h2 class="anchored" data-anchor-id="slice-time-correction-before-or-after-motion-correction">Slice time correction: before or after motion correction?</h2>
<p><img src="images/clipboard-531438222.png" class="img-fluid"></p>
<div class="notes">

</div>
</section>
<section id="simultaneous-multislice-smsmultiband-mb-acquisitions" class="level2">
<h2 class="anchored" data-anchor-id="simultaneous-multislice-smsmultiband-mb-acquisitions">Simultaneous multislice (SMS)/multiband (MB) acquisitions</h2>
<p><img src="images/clipboard-4224634755.png" class="img-fluid"></p>
<div class="notes">

</div>
</section>
<section id="susceptibility-distortions" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="susceptibility-distortions">Susceptibility distortions</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p><img src="images/clipboard-2292545657.png" class="img-fluid"></p>
</div><div class="column" style="width:50%;">
<p><img src="images/clipboard-4144129888.png" class="img-fluid"></p>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>Image source: https://mriquestions.com/susceptibility-artifact.html</p>
</div></div><div class="notes">

</div>
</section>
<section id="field-map" class="level2">
<h2 class="anchored" data-anchor-id="field-map">Field map</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://mriquestions.com/susceptibility-artifact.html"><img src="images/clipboard-4083027118.png" class="img-fluid figure-img" alt="Image source: https://mriquestions.com/susceptibility-artifact.html"></a></p>
<figcaption>Image source: https://mriquestions.com/susceptibility-artifact.html</figcaption>
</figure>
</div>
</section>
<section id="reverse-pe-polarity" class="level2">
<h2 class="anchored" data-anchor-id="reverse-pe-polarity">Reverse PE polarity</h2>
<div class="r-stack">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/epi_AP.png" class="fragment img-fluid figure-img"></p>
<figcaption>A&gt;P vs.&nbsp;P&gt;A</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/epi_PA.png" class="fragment img-fluid figure-img"></p>
<figcaption>.</figcaption>
</figure>
</div>
</div>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gambling: to view these images, type in the terminal:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ml</span> freesurfer</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">freeview</span> <span class="dt">\</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/sub-001/ses-1/func/sub-001_ses-1_task-gambling_acq-Fs2_run-1_bold.nii.gz <span class="dt">\</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/sub-001/ses-1/fmap/sub-001_ses-1_acq-Fs2_dir-PA_epi.nii.gz <span class="dt">\</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>-ras 3 61 28</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="notes">

</div>
</section>
<section id="apply-the-deformation-field" class="level2">
<h2 class="anchored" data-anchor-id="apply-the-deformation-field">Apply the deformation field</h2>
<div class="r-stack">
<p><img src="images/sub-001_ses-1_task-gambling_acq-Fs2_run-1_desc-sdc_bold_distorted.png" class="fragment img-fluid"></p>
<p><img src="images/sub-001_ses-1_task-gambling_acq-Fs2_run-1_desc-sdc_bold_corrected.png" class="fragment img-fluid"></p>
</div>
<pre><code>file:///home/jovyan/gambling/bids/derivatives/fmriprep/sub-001.html</code></pre>
<div class="notes">
<p>Here you can see how e.g.&nbsp;the copmpressed inferior frontal lobe regions get unwarped (although lost signal can’t be recovered completely).</p>
</div>
</section>
<section id="co-registration" class="level2">
<h2 class="anchored" data-anchor-id="co-registration">Co-registration</h2>
<div class="r-stack">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/example_func_raw.png" class="fragment img-fluid figure-img"></p>
<figcaption>2.5 mm iso T2*w vs.&nbsp;1 mm iso T1w</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/example_struc.png" class="fragment img-fluid figure-img"></p>
<figcaption>2.5 mm iso T2*w vs.&nbsp;1 mm iso T1w</figcaption>
</figure>
</div>
</div>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gambling: </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ml</span> freesurfer</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">freeview</span> <span class="st">'</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="st">/home/jovyan/gambling/bids/sub-001/ses-1/anat/sub-001_ses-1_acq-mprage_T1w.nii.gz \</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="st">/home/jovyan/gambling/bids/sub-001/ses-1/func/sub-001_ses-1_task-gambling_acq-Fs2_run-1_bold.nii.gz</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="notes">
<p>Purpose #1: view individual activation on a high quality anatomical image</p>
<p>Purpose #2: mapping to standard space (normalization)</p>
</div>
</section>
<section id="mutual-information-maximization" class="level2">
<h2 class="anchored" data-anchor-id="mutual-information-maximization">Mutual information maximization</h2>
<p><img src="images/clipboard-2185521072.png" class="img-fluid" width="454"></p>
<div class="cell" data-python.reticulate="false">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># source: chatgpt</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.ndimage <span class="im">import</span> shift</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mutual_info_score</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_realistic_fish(size<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> np.zeros((size, size))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    cx, cy <span class="op">=</span> size <span class="op">//</span> <span class="dv">2</span>, size <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw backbone (slight curve)</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">20</span>, <span class="dv">80</span>):</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> <span class="bu">int</span>(cy <span class="op">+</span> <span class="dv">5</span> <span class="op">*</span> np.sin((x <span class="op">-</span> <span class="dv">20</span>) <span class="op">/</span> <span class="dv">60</span> <span class="op">*</span> np.pi))  <span class="co"># slight wave</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        img[x, y] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw ribs (angled lines)</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">25</span>, <span class="dv">75</span>, <span class="dv">5</span>):</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> <span class="bu">int</span>(cy <span class="op">+</span> <span class="dv">5</span> <span class="op">*</span> np.sin((x <span class="op">-</span> <span class="dv">20</span>) <span class="op">/</span> <span class="dv">60</span> <span class="op">*</span> np.pi))</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> dy <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="dv">0</span> <span class="op">&lt;=</span> y <span class="op">-</span> dy <span class="op">&lt;</span> size:</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>                img[x, y <span class="op">-</span> dy] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="dv">0</span> <span class="op">&lt;=</span> y <span class="op">+</span> dy <span class="op">&lt;</span> size:</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                img[x, y <span class="op">+</span> dy] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw head (big circle)</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">11</span>):</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">11</span>):</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> j<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="dv">100</span>:</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>                xi <span class="op">=</span> <span class="dv">20</span> <span class="op">+</span> i</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>                yj <span class="op">=</span> cy <span class="op">+</span> j</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="dv">0</span> <span class="op">&lt;=</span> xi <span class="op">&lt;</span> size <span class="kw">and</span> <span class="dv">0</span> <span class="op">&lt;=</span> yj <span class="op">&lt;</span> size:</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                    img[xi, yj] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw eye (small dot)</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    img[<span class="dv">17</span>, cy <span class="op">+</span> <span class="dv">5</span>] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># black eye (making a small black pixel inside head)</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw tail fin (V shape)</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        x1, y1 <span class="op">=</span> <span class="dv">80</span> <span class="op">+</span> d, cy <span class="op">-</span> d</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        x2, y2 <span class="op">=</span> <span class="dv">80</span> <span class="op">+</span> d, cy <span class="op">+</span> d</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="dv">0</span> <span class="op">&lt;=</span> x1 <span class="op">&lt;</span> size <span class="kw">and</span> <span class="dv">0</span> <span class="op">&lt;=</span> y1 <span class="op">&lt;</span> size:</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>            img[x1, y1] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="dv">0</span> <span class="op">&lt;=</span> x2 <span class="op">&lt;</span> size <span class="kw">and</span> <span class="dv">0</span> <span class="op">&lt;=</span> y2 <span class="op">&lt;</span> size:</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>            img[x2, y2] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw dorsal (top) fin</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>        x, y <span class="op">=</span> <span class="dv">40</span> <span class="op">-</span> d<span class="op">//</span><span class="dv">2</span>, cy <span class="op">-</span> <span class="dv">12</span> <span class="op">-</span> d</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="dv">0</span> <span class="op">&lt;=</span> x <span class="op">&lt;</span> size <span class="kw">and</span> <span class="dv">0</span> <span class="op">&lt;=</span> y <span class="op">&lt;</span> size:</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>            img[x, y] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw ventral (bottom) fin</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>        x, y <span class="op">=</span> <span class="dv">60</span> <span class="op">+</span> d<span class="op">//</span><span class="dv">2</span>, cy <span class="op">-</span> <span class="dv">12</span> <span class="op">-</span> d</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="dv">0</span> <span class="op">&lt;=</span> x <span class="op">&lt;</span> size <span class="kw">and</span> <span class="dv">0</span> <span class="op">&lt;=</span> y <span class="op">&lt;</span> size:</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>            img[x, y] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Create fixed image (realistic fish skeleton)</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>fixed <span class="op">=</span> create_realistic_fish()</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Create moving image with inverted contrast</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>moving <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> fixed</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduce a misalignment</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> shift_image(img, dx, dy):</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shift(img, shift<span class="op">=</span>(dx, dy), mode<span class="op">=</span><span class="st">'constant'</span>, cval<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>moving_misaligned <span class="op">=</span> shift_image(moving, <span class="dv">4</span>, <span class="dv">5</span>)</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Define mutual information computation</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_mi(img1, img2, bins<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    img1_flat <span class="op">=</span> img1.ravel()</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    img2_flat <span class="op">=</span> img2.ravel()</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    c_xy <span class="op">=</span> np.histogram2d(img1_flat, img2_flat, bins<span class="op">=</span>bins)[<span class="dv">0</span>]</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    mi <span class="op">=</span> mutual_info_score(<span class="va">None</span>, <span class="va">None</span>, contingency<span class="op">=</span>c_xy)</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mi</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for best alignment by shifting</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>dx_range <span class="op">=</span> np.arange(<span class="op">-</span><span class="dv">10</span>, <span class="dv">11</span>)</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>dy_range <span class="op">=</span> np.arange(<span class="op">-</span><span class="dv">10</span>, <span class="dv">11</span>)</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>mi_matrix <span class="op">=</span> np.zeros((<span class="bu">len</span>(dx_range), <span class="bu">len</span>(dy_range)))</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, dx <span class="kw">in</span> <span class="bu">enumerate</span>(dx_range):</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j, dy <span class="kw">in</span> <span class="bu">enumerate</span>(dy_range):</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>        shifted <span class="op">=</span> shift_image(moving_misaligned, dx, dy)</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>        mi_matrix[i, j] <span class="op">=</span> compute_mi(fixed, shifted)</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Find best shift</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>best_idx <span class="op">=</span> np.unravel_index(np.argmax(mi_matrix), mi_matrix.shape)</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>best_dx <span class="op">=</span> dx_range[best_idx[<span class="dv">0</span>]]</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>best_dy <span class="op">=</span> dy_range[best_idx[<span class="dv">1</span>]]</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Best shift: dx = </span><span class="sc">{</span>best_dx<span class="sc">}</span><span class="ss">, dy = </span><span class="sc">{</span>best_dy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply best shift</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>moving_corrected <span class="op">=</span> shift_image(moving_misaligned, best_dx, best_dy)</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].imshow(fixed, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Fixed Image (Realistic Fish Skeleton)'</span>)</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].imshow(moving_misaligned, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Moving Misaligned Image'</span>)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].imshow(moving_corrected, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Moving Corrected Image'</span>)</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>cax <span class="op">=</span> axs[<span class="dv">1</span>,<span class="dv">1</span>].imshow(mi_matrix, extent<span class="op">=</span>[dy_range[<span class="dv">0</span>], dy_range[<span class="op">-</span><span class="dv">1</span>], dx_range[<span class="op">-</span><span class="dv">1</span>], dx_range[<span class="dv">0</span>]], cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'Mutual Information Map'</span>)</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'dy'</span>)</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'dx'</span>)</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>fig.colorbar(cax, ax<span class="op">=</span>axs[<span class="dv">1</span>,<span class="dv">1</span>])</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="notes">

</div>
</section>
<section id="boundary-based-registration" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="boundary-based-registration">Boundary-based registration</h2>
<p><img src="images/clipboard-3073663984.png" class="img-fluid" width="524"></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><span class="citation" data-cites="greve2009">(<a href="#ref-greve2009" role="doc-biblioref">Greve and Fischl 2009</a>)</span></p>
</div></div><div class="notes">
<p>Currently considered best for its purpose and is implemented in fMRIprep. Requires surface reconstruction of the anatomical scan.</p>
</div>
</section>
<section id="coregistration-result" class="level2">
<h2 class="anchored" data-anchor-id="coregistration-result">Coregistration result</h2>
<div class="r-stack">
<p><img src="images/sub-001_ses-1_task-gambling_acq-Fs2_run-2_desc-coreg_bold_T1w.png" class="fragment img-fluid" width="1677"></p>
<p><img src="images/sub-001_ses-1_task-gambling_acq-Fs2_run-2_desc-coreg_bold_epi.png" class="fragment img-fluid" width="1677"></p>
</div>
<pre><code># gambling:
file:///home/jovyan/gambling/bids/derivatives/fmriprep/sub-001.html</code></pre>
</section>
<section id="corgistration-before-vs.-after" class="level2">
<h2 class="anchored" data-anchor-id="corgistration-before-vs.-after">Corgistration before vs.&nbsp;after</h2>
<div class="r-stack">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/example_struc-01.png" class="fragment img-fluid figure-img"></p>
<figcaption>struct -&gt; raw struct -&gt; coreg</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/example_func_raw-01.png" class="fragment img-fluid figure-img"></p>
<figcaption>struct -&gt; raw struct -&gt; coreg</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/example_struc-03.png" class="fragment img-fluid figure-img"></p>
<figcaption>struct -&gt; raw struct -&gt; coreg</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/example_func_coreg.png" class="fragment img-fluid figure-img"></p>
<figcaption>struct -&gt; raw struct -&gt; coreg</figcaption>
</figure>
</div>
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gambling:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ml</span> freesurfer</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">freeview</span> <span class="dt">\</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/sub-001/ses-1/anat/sub-001_ses-1_acq-mprage_T1w.nii.gz <span class="dt">\</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/sub-001/ses-1/func/sub-001_ses-1_task-gambling_acq-Fs2_run-1_bold.nii.gz <span class="dt">\</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>/home/jovyan/gambling/bids/derivatives/fmriprep/sub-001/ses-1/func/sub-001_ses-1_task-gambling_acq-Fs2_run-1_space-T1w_desc-preproc_bold.nii.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sec-normalization" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="sec-normalization">Normalization to template space</h2>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 48.8%;justify-content: center;">
<p><img src="images/clipboard-3612936232.png" class="img-fluid" width="293"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 51.2%;justify-content: center;">
<p><img src="images/clipboard-341128693.png" class="img-fluid" width="308"></p>
</div>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>Image source: <a href="https://publicdomainreview.org/collection/phrenology-diagrams-from-vaught-s-practical-character-reader-1902/" class="uri">https://publicdomainreview.org/collection/phrenology-diagrams-from-vaught-s-practical-character-reader-1902/</a></p>
</div></div><div class="notes">
<p>Finally, if you are preforming a group study, you also need to map each individual subject into some common space. This is not a trivial task. As head shpaes of people are different, there brain shapes are also different. Here I tried to draw the approximate shape if each of these guy’s brains, and some hypothetical template brain.</p>
<p>Normalization is needed to compensate for individual differences in brain shape for the group analysis.</p>
</div>
</section>
<section id="talairach-atlas" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="talairach-atlas">Talairach atlas</h2>
<p><img src="images/clipboard-2941316355.png" class="img-fluid" width="569"></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>Image source: Talairach and Tourneux, <a href="https://www.amazon.com/Co-Planar-Stereotaxic-Atlas-Human-Brain/dp/0865772932">1988</a> (to be confirmed)</p>
</div></div><div class="notes">
<p>Normalization is also needed for a unified coordinate system. You will see that standard coordinates are reported in the articles.</p>
</div>
</section>
<section id="mni-tamplate" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="mni-tamplate">MNI tamplate</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1564359472.png" class="img-fluid figure-img"></p>
<figcaption>mni_icbm152_t1_tal_nlin_asym_09c</figcaption>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>Image source:</p>
<p><a href="https://www.bic.mni.mcgill.ca/ServicesAtlases/ICBM152NLin2009" class="uri">https://www.bic.mni.mcgill.ca/ServicesAtlases/ICBM152NLin2009</a></p>
</div></div><div class="notes">
<p>Further reading: <a href="https://imaging.mrc-cbu.cam.ac.uk/imaging/MniTalairach" class="uri">https://imaging.mrc-cbu.cam.ac.uk/imaging/MniTalairach</a></p>
</div>
</section>
<section id="mapping-to-template" class="level2">
<h2 class="anchored" data-anchor-id="mapping-to-template">Mapping to template</h2>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3564733756.png" class="img-fluid figure-img"></p>
<figcaption>rigid body</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3082885370.png" class="img-fluid figure-img"></p>
<figcaption>affine</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1380849325.png" class="img-fluid figure-img"></p>
<figcaption>nonlinear (“warp”)</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="notes">
<p>To match each of them to the template, it is not enough to coregister them as we did for motion correction, because obviously they are of different sizes. We can add 6 more paraeters to the transform, which compensates does scaling and shearing, to better align them. However, there will still be places wehere they do not align perfectly, because one guy one has a bigger frontal lobe, and gy to a bigger parietal lobe</p>
</div>
</section>
<section id="nonlinear-transform" class="level2">
<h2 class="anchored" data-anchor-id="nonlinear-transform">Nonlinear transform</h2>
<p><img src="images/clipboard-1848593852.png" class="img-fluid"></p>
<div class="notes">
<p>So some software packages use a nonlinear warping algorithm to align brains. There you have to estimate a 3D deformation field and then nonlinearly warp each brain onto a template. They are called non-linear, because different parts of the volume are scaled differently.</p>
</div>
</section>
<section id="normalization-is-done-using-a-structural-scan" class="level2">
<h2 class="anchored" data-anchor-id="normalization-is-done-using-a-structural-scan">Normalization is done using a structural scan</h2>
<p><img src="images/clipboard-3641481833.png" class="img-fluid"></p>
<div class="notes">
<p>The mapping to common space is usually done via an anatomical scan. First, each subject functional and anatomical scans are coregistered with each other, and then each subject’s anatomical scan is mapped into a template. This is done because the anatomical scan has better quality, and hence the estimated transform is more precise. After you have done that each area in one subject corresponds to the same area in the other subject and you can perform averaging on them.</p>
</div>
</section>
<section id="volume-based-normalization" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="volume-based-normalization">Volume-based normalization</h2>
<section id="unified-segmentation" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="unified-segmentation">Unified segmentation</h3>
<p><img src="images/clipboard-2796471972.png" class="img-fluid" width="404"></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><span class="citation" data-cites="ashburner2005">(<a href="#ref-ashburner2005" role="doc-biblioref">Ashburner and Friston 2005</a>)</span></p>
</div></div><div class="notes">
<p>Unified segmentation is still the best algorithm. It performs bias correction, tissue segmentation and normalization in one step.</p>
</div>
</section>
</section>
<section id="surface-based-registration" class="level2">
<h2 class="anchored" data-anchor-id="surface-based-registration">Surface-based registration</h2>
<p><img src="images/clipboard-162265907.png" class="img-fluid"></p>
<div class="notes">
<p>Fsaverage: 40 subjects; Align 39 subjects to 1; create an atlas; align 40 subjects to an atlas; re-create atlas; align 40 subject to the atlas; re-create atlas.</p>
<p>Using knolwdge from freesurfer recon, each voxel together with it’s time course is maped to one of the 3 atlas spaces: either the left cortical hemisphere, the right hemisphere or the subcrotical structures like the basal ganglia, amygldala, brainstem, etc. And the atlas spaces in this case are fsaverage. After this, the spatial smoothing is done either in 2D or in 3D depending on whether it is a surface space or a volume subcortical space, and voxels that do not belong to the space is being basked out.</p>
</div>
</section>
<section id="spatial-smoothing" class="level2">
<h2 class="anchored" data-anchor-id="spatial-smoothing">Spatial smoothing</h2>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-2607279937.png" class="img-fluid figure-img" width="397"></p>
<figcaption>original</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-4123011299.png" class="img-fluid figure-img" width="424"></p>
<figcaption>smoothed</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="notes">
<p>Finally, each volume is typically smoothed with a gaussian to increase the signal and supress noise. The amount of smoothing is usally expressed by the shape of the gaussian, which, in turn, is described by it’s full withd at half maximum. Here are the examples of the original volume, the smoothed volume at 5 fwhm and 10 fwhm. You can see that the signal increase happens at the expense of the spatial resolution.</p>
</div>
</section>
<section id="full-width-at-half-maximum" class="level2">
<h2 class="anchored" data-anchor-id="full-width-at-half-maximum">Full width at half maximum</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load library</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Gaussian function</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>gaussian <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>) {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">/</span> (sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> pi))) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span> (x <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> sigma<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="at">length.out =</span> <span class="dv">1000</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">gaussian</span>(x, <span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Find half maximum</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>ymax <span class="ot">&lt;-</span> <span class="fu">max</span>(y)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>half_max <span class="ot">&lt;-</span> ymax <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Solve for FWHM points</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>left_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(y <span class="sc">&gt;=</span> half_max)[<span class="dv">1</span>]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>right_idx <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">which</span>(y <span class="sc">&gt;=</span> half_max), <span class="dv">1</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>x_left <span class="ot">&lt;-</span> x[left_idx]</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>x_right <span class="ot">&lt;-</span> x[right_idx]</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>fwhm_value <span class="ot">&lt;-</span> x_right <span class="sc">-</span> x_left</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> half_max, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(x_left, x_right), <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> half_max <span class="sc">+</span> <span class="fl">0.02</span>, <span class="at">label =</span> <span class="st">"Half Maximum"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> x_left <span class="sc">-</span> <span class="fl">0.3</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, x_left), <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> x_right <span class="sc">+</span> <span class="fl">0.3</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, x_right), <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="fl">0.15</span>, <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"FWHM ="</span>, <span class="fu">round</span>(fwhm_value, <span class="dv">2</span>)), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Gaussian Curve with FWHM"</span>,</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"x"</span>,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Amplitude"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="preprocessing_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Gaussian curve with FWHM</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="spatial-smoothing-1" class="level2">
<h2 class="anchored" data-anchor-id="spatial-smoothing-1">Spatial smoothing</h2>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-2607279937.png" class="img-fluid figure-img" width="353"></p>
<figcaption>original</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-616171166.png" class="img-fluid figure-img" width="365"></p>
<figcaption>5 mm FWHM</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-4123011299.png" class="img-fluid figure-img" width="376"></p>
<figcaption>10 mm FWHM</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="notes">
<p>Purpose1: increase the signal and suppress the noise</p>
<p>Purpose2: even better compensate for inter-individual differences</p>
<p>FMRIprep does not smooth the data</p>
</div>
</section>
<section id="critique" class="level2">
<h2 class="anchored" data-anchor-id="critique">Critique</h2>
<p><img src="images/clipboard-747002276.png" class="img-fluid"></p>
<p><span class="citation" data-cites="stelzer2014">(<a href="#ref-stelzer2014" role="doc-biblioref">Stelzer et al. 2014</a>)</span></p>
<div class="notes">
<p>Volume smoothing has been heavily criticized by some influential people in the field. It has even been called “deficient approaches to human neuroimaging”. Because it does not only degrade the resolution, but also decreases the effect size. But it is still being done in many cases – it all depends on the questions you are asking</p>
</div>
</section>
<section id="surface-based-smoothing" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="surface-based-smoothing">Surface-based smoothing</h2>
<p><img src="images/clipboard-1388558210.png" class="img-fluid" width="362"></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>slide courtesy of Doug Greve</p>
</div></div><div class="notes">
<p>5 mm apart in 3D</p>
<p>25 mm apart on surface</p>
<p>Averaging with other tissue types (WM, CSF)</p>
<p>Averaging with other functional areas</p>
<p>One important feature is that fsfast allows surface-based processing, and therefore overcomes some of the difficulties caused by smoothing.</p>
<p>Here is an example of how it works. Here is a piece of freesrurfer reconstructed cortical surface with yellow a white matter surface and red the the gray matter surface. The two points, on opposite banks of the sulcus, are only 5 mm apart in the volume, however, they are very far from each other on the surface. So these two points can be two completely different functional areas. However, if you smooth on the volume, as shown here, you will mix them together. Surface smoothing routines use the information from the freesurfer’s surface reconstruction and smoothe the data along the cortical surface. This allows to take advantage of smoothing procedure without mixing these two areas together.</p>
</div>
</section>
<section id="fmriprep-1" class="level2">
<h2 class="anchored" data-anchor-id="fmriprep-1">fMRIprep</h2>
<div class="columns">
<div class="column" style="width:50%;">
<section id="pros" class="level3">
<h3 class="anchored" data-anchor-id="pros">Pros</h3>
<ul>
<li>Useful for processing many subjects, whole-brain data, standard acquisition protocols</li>
<li>Collection of best practices from all software</li>
<li>HPC compatibility</li>
<li>Useful for “users” when knowledgeable people assist them</li>
<li>Automatic quality control</li>
<li>Increases reproducibility (?)</li>
</ul>
</section>
</div><div class="column" style="width:50%;">
<section id="cons" class="level3">
<h3 class="anchored" data-anchor-id="cons">Cons</h3>
<ul>
<li>Difficult/impossible to use for custom acquisitions</li>
<li>Difficult/impossible to manually intervene</li>
<li>May not be worth it with few subjects are being processed</li>
<li>Requires a Linux environment and corresponding knowledge</li>
<li>Need integration with the software you will use for your analysis</li>
<li>Hard to explain what you did (black box)</li>
</ul>
</section>
</div>
</div>
<div class="notes">

</div>
</section>
<section id="example-i" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="example-i">Example I</h2>
<p><img src="images/clipboard-4082303266.png" class="img-fluid"></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><span class="citation" data-cites="arsenovic2022">(<a href="#ref-arsenovic2022" role="doc-biblioref">Arsenovic, Ischebeck, and Zaretskaya 2022</a>)</span></p>
</div></div><div class="notes">

</div>
</section>
<section id="example-ii" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="example-ii">Example II</h2>
<p><img src="images/clipboard-268630360.png" class="img-fluid" width="505"></p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p><span class="citation" data-cites="coates2024a">(<a href="#ref-coates2024a" role="doc-biblioref">Coates et al. 2024</a>)</span></p>
</div></div><div class="notes">

</div>
</section>
<section id="run-fmriprep" class="level2">
<h2 class="anchored" data-anchor-id="run-fmriprep">Run fMRIprep</h2>
<p>Before running</p>
<ul>
<li><p>Apply for a freesurfer license file: <a href="https://surfer.nmr.mgh.harvard.edu/registration.html" class="uri">https://surfer.nmr.mgh.harvard.edu/registration.html</a></p></li>
<li><p>Download it and store in /home/jovyan/license.txt (or wherever you like)</p></li>
</ul>
<p><img src="images/clipboard-997717132.png" class="img-fluid"></p>
<section id="run-fmriprep-as-follows" class="level3">
<h3 class="anchored" data-anchor-id="run-fmriprep-as-follows">Run fMRIprep as follows</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create freesurfer subject directory</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /home/jovyan/gambling/bids/derivatives/fmriprep/sourcedata/freesurfer/</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># define the path to the freesurfer subject directory</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="va">SUBJECTS_DIR</span><span class="op">=</span>/home/jovyan/gambling/bids/derivatives/fmriprep/sourcedata/freesurfer/</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># run fMRIprep with 4 output spaces: T1 native, MNI, fsnative, fsaverage</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ex">fmriprep</span> /home/jovyan/gambling/bids/ /home/jovyan/gambling/bids/derivatives/fmriprep/ <span class="dt">\</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>participant <span class="dt">\</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>--fs-license-file /home/jovyan/license.txt <span class="dt">\</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>--output-spaces T1w MNI152NLin2009cAsym fsnative fsaverage </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After this, we need to wait for some ˜ 3-4 hours, while magic happens.</p>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-arsenovic2022" class="csl-entry" role="listitem">
Arsenovic, Ana, Anja Ischebeck, and Natalia Zaretskaya. 2022. <span>“Dissociation Between Attention-Dependent and Spatially Specific Illusory Shape Responses Within the Topographic Areas of the Posterior Parietal Cortex.”</span> <em>The Journal of Neuroscience</em>, September. <a href="https://doi.org/10.1523/JNEUROSCI.0723-22.2022">https://doi.org/10.1523/JNEUROSCI.0723-22.2022</a>.
</div>
<div id="ref-ashburner2005" class="csl-entry" role="listitem">
Ashburner, John, and Karl J Friston. 2005. <span>“Unified Segmentation.”</span> <em>NeuroImage</em> 26 (3): 839–51. <a href="https://doi.org/10.1016/j.neuroimage.2005.02.018">https://doi.org/10.1016/j.neuroimage.2005.02.018</a>.
</div>
<div id="ref-coates2024a" class="csl-entry" role="listitem">
Coates, Adam, David Linhardt, Christian Windischberger, Anja Ischebeck, and Natalia Zaretskaya. 2024. <span>“High-Resolution 7T fMRI Reveals the Visual Zone of the Human Claustrum.”</span> <em>Imaging Neuroscience</em> 2 (October): 1–15. <a href="https://doi.org/10.1162/imag_a_00327">https://doi.org/10.1162/imag_a_00327</a>.
</div>
<div id="ref-esteban2018" class="csl-entry" role="listitem">
Esteban, Oscar, Christopher J. Markiewicz, Ross W. Blair, Craig A. Moodie, A. Ilkay Isik, Asier Erramuzpe, James D. Kent, et al. 2018. <span>“fMRIPrep: A Robust Preprocessing Pipeline for Functional MRI.”</span> <em>Nature Methods</em> 16 (1): 111–16. <a href="https://doi.org/10.1038/s41592-018-0235-4">https://doi.org/10.1038/s41592-018-0235-4</a>.
</div>
<div id="ref-greve2009" class="csl-entry" role="listitem">
Greve, Douglas N., and Bruce Fischl. 2009. <span>“Accurate and Robust Brain Image Alignment Using Boundary-Based Registration.”</span> <em>NeuroImage</em> 48 (1): 63–72. <a href="https://doi.org/10.1016/j.neuroimage.2009.06.060">https://doi.org/10.1016/j.neuroimage.2009.06.060</a>.
</div>
<div id="ref-stelzer2014" class="csl-entry" role="listitem">
Stelzer, Johannes, Gabriele Lohmann, Karsten Mueller, Tilo Buschmann, and Robert Turner. 2014. <span>“Deficient Approaches to Human Neuroimaging.”</span> <em>Frontiers in Human Neuroscience</em> 8 (July). <a href="https://doi.org/10.3389/fnhum.2014.00462">https://doi.org/10.3389/fnhum.2014.00462</a>.
</div>
<div id="ref-tierney2025" class="csl-entry" role="listitem">
Tierney, Tim M., Nicholas A. Alexander, Nicole Labra Avila, Yael Balbastre, Gareth Barnes, Yulia Bezsudnova, Mikael Brudfors, et al. 2025. <span>“SPM 25: Open Source Neuroimaging Analysis Software.”</span> <a href="https://doi.org/10.48550/ARXIV.2501.12081">https://doi.org/10.48550/ARXIV.2501.12081</a>.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./data_management.html" class="pagination-link" aria-label="Data management">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data management</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>